name: Upload Example Stats

# Temp only dispatch on manual dispatch
on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}

jobs:
  install:
    name: Install deps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v3
        env:
          cache-name: cache-codecov-js-bundle-plugin-node-modules
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.cache-name }}-

      - name: Install dependencies
        run: pnpm install

build-and-upload-stats-data:
  name: Build and upload ${{ matrix.example }} stats data
  runs-on: ubuntu-latest
  needs: install
  strategy:
    fail-fast: false
    matrix:
      example: [
        # Temp removing until I can figure out a way to have multiple configs
        # "next-js",
        "rollup",
        "vite",
        "webpack"
      ]
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Setup node
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        run_install: false

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Cache node_modules
      id: cache-node-modules
      uses: actions/cache@v3
      env:
        cache-name: cache-codecov-js-bundle-plugin-node-modules
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-${{ env.cache-name }}-

    - name: Install dependencies
      run: pnpm install

    - name: Build plugins
      run: pnpm run build

    - name: Install built plugins
      run: pnpm install

    - name: Build ${{ matrix.example }} app
      working-directory: ./examples/${{ matrix.example }}
      run: pnpm run build:staging
